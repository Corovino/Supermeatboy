package tile;

import java.awt.Graphics;
import java.awt.Image;
import java.awt.Toolkit;
import java.awt.image.BufferedImage;
import java.io.File;
import java.io.IOException;
import java.util.ArrayList;

import javax.imageio.ImageIO;
import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.parsers.ParserConfigurationException;
import javax.xml.xpath.XPath;
import javax.xml.xpath.XPathExpressionException;
import javax.xml.xpath.XPathFactory;

import org.w3c.dom.Document;
import org.xml.sax.SAXException;

public class TileSet {
	private int tileHeight;
	private int tileWidth;
	private int firstgid;
	private int lastgid;
	private int imageWidth;
	private int imageHeight;
	private String tmxfile;
	private BufferedImage image;
	private static ArrayList<Tile> alltiles;
	public TileSet(int tileHeight, int tileWidth, String tmx){
		this.tileHeight = tileHeight;
		this.tileWidth = tileWidth;	
		tmxfile=tmx;
		alltiles= new ArrayList<Tile>();
		try {
			read(tmx);
		} catch (XPathExpressionException | SAXException
				| ParserConfigurationException | IOException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
	}
	public void load(String src) throws IOException{
		
		image = ImageIO.read(new File(src));
		int end = (imageWidth/tileWidth)*(imageHeight/tileHeight);
		for(int i=0;i<end;i++){
			int x=firstgid*(i-1)*tileHeight;
			int y = lastgid*(i-1)*tileWidth;		
			BufferedImage bi=image.getSubimage(x, y, tileWidth, tileHeight)	;		
			Tile tmp = new Tile(x,y,bi);
			alltiles.add(tmp);
		}
	}
	public void read(String fname) throws XPathExpressionException, SAXException, ParserConfigurationException, IOException{
		DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();
		DocumentBuilder builder = factory.newDocumentBuilder();
		XPathFactory xpfactory = XPathFactory.newInstance();
      	XPath path = xpfactory.newXPath();
		File f = new File("resources/"+tmxfile);
		Document doc = builder.parse(f);
		int numTileSets = Integer.parseInt(path.evaluate("counts(layer)", doc));
		for(int i=1;i<=numTileSets;i++){
			String src=path.evaluate("/map/tileset["+i+"]/image/@source", doc);
			load("resources/" +src);
		}
	}
	public ArrayList<Tile> getTiles(){
		return alltiles;
	}
}
